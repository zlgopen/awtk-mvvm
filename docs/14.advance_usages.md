## 14. 高级用法

### 14.1 特殊属性绑定

在前面的介绍中，数据绑定都是以 text 属性和 value 属性为例的。实际上，数据绑定可以作用于控件的任意属性。比如，可以绑定 enable 属性来决定控件是否可用，绑定 visible 属性来决定控件是否可见。在下面的几个例子中，我们来看看几种常见属性的绑定方法和应用场景。

#### 14.1.1 控件的显示和隐藏

在有的情况下，我们希望界面上某些控件隐藏起来，在另外一种情况下，我们又希望界面上这些控件能显示出来，这可以通过绑定 visible 属性来实现。

比如，在下面的例子中，其中一个 label 控件在 value 小于 50 时隐藏，另外一个 label 控件在 value 大于 50 时隐藏。视图的 XML 可以这样写：

```xml
<window v-model="temperature.js">
  <label x="center" y="middle:-40" w="50%" h="40" v-data:visible="{$value > 50}" text="Visible if value > 50"/>
  <label x="center" y="middle:-40" w="50%" h="40" v-data:visible="{$value < 50}" text="Visible if value < 50"/>
  <label x="center" y="middle" w="50%" h="40" v-data:text="{value}"/>
  <slider x="center" y="middle:40" w="80%" h="20" v-data:value="{value}"/>
</window>
```

这里"{$value > 50}"是嵌入的表达式，表达式的用法后面会详细介绍，这里的意思是 value 属性的值大于 50 时，该表达式为真，此时控件可见，否则控件不可见。

前面曾经提到，AWTK-MVVM 并不擅长处理动态界面，而 visible 的属性绑定，可以在一定程度上帮助我们实现界面的动态变化，请根据具体情况酌情使用。

这里，界面上多了两个控件，任然使用了 temperature.js 作为 ViewModel, 而不需要对 temperature.js 进行任何修改。由此也可以看出， View 和 ViewModel 之间是一种松耦合。

Windows 的命令行下，读者可以运行 demo17 来查看实际的效果。

```
bin\jsdemo17
```

#### 14.1.2 数据联动

AWTK-MVVM 非常擅长处理数据联动。数据联动是指一个控件的数据变化，会引起其它相关控件的变化。

填写收货地址就是一个典型的数据联动的例子：

* 选择"省/直辖市"时，"城市"要跟着变化，"区县"也要跟着变化，完整地址也要跟着变化。

* 选择"城市"时，"区县"要跟着变化，完整地址也要跟着变化。

* 选择"区县"时，完整地址要跟着变化。

* 输入"详细地址"时，完整地址要跟着变化。

![address](images/address.png)

如果采用传统方式来开发，不但要写一大堆代码去处理事件，更重要的是这些代码与界面耦合到一起，难以维护和自动测试。

现在我们来看看 AWTK-MVVM 如何实现数据联动：

视图的 XML 文件：

```xml
<window v-model="address.js"> 
  <combo_box x="center" y="middle:-80" w="60%" h="30" v-data:options="{province_list}" v-data:text="{province}"/>
  <combo_box x="center" y="middle:-40" w="60%" h="30" v-data:options="{city_list}" v-data:text="{city}"/>
  <combo_box x="center" y="middle" w="60%" h="30" v-data:options="{country_list}" v-data:text="{country}"/>
  <edit x="center" y="middle:40" w="60%" h="30" v-data:value="{detail, Trigger=Changing}" tips="detail address"/>
  <hscroll_label x="center" y="middle:80" w="90%" h="30" v-data:text="{address}"/>
</window>
```

这里把 combo\_box 属性 options 绑定到 ViewModel 相应的数据上，ViewModel 的数据变化时，会自动更新到界面上。比如城市列表绑定到 city\_list 数据上，只要 city\_list 变化，城市列表会自动更新。

ViewModel 的实现：

> 为简明起见，这里只使用了很少的 demo 数据。

```js
function Address() {
  this._province = '广东';
  this._city = '广州';
  this.country = '天河区';
  this.detail = '';

  this.data = {
    '北京': {
      '北京': ['东城区', '西城区', '朝阳区','丰台区','石景山区','海淀区','']
    }, 
    '上海': {
      '上海': ['黄浦区', '徐汇区','长宁区','静安区','普陀区','虹口区','杨浦区']
    }, 
    '广东': {
      '广州':['天河区','黄埔区','荔湾区','越秀区','海珠区'],
      '深圳':['罗湖区','福田区','南山区','宝安区','龙岗区']
    }
  };
}

Object.defineProperty(Address.prototype, 'province_list', {
  get: function () {
    return Object.keys(this.data).join(';');
  }
})

//根据当前的省/直辖市返回城市列表。
Object.defineProperty(Address.prototype, 'city_list', {
  get: function () {
    return Object.keys(this.data[this._province]).join(';');
  }
})

//根据当前的省/直辖市和城市返回区县列表。
Object.defineProperty(Address.prototype, 'country_list', {
  get: function () {
    return this.data[this._province][this._city].join(';');
  }
})

//地址由省/直辖市、城市、区县和详细地址合成。
Object.defineProperty(Address.prototype, 'address', {
  get: function () {
    return this._province + this._city + this.country + this.detail;
  }
})

//修改省/直辖市时，同时修改缺省的城市。
Object.defineProperty(Address.prototype, 'province', {
  get: function () {
    return this._province;
  },
  set: function (val) {
    this._province = val;
    this.city = this.city_list.split(';')[0]; 
  }
})

//修改城市时，同时修改缺省的区县。
Object.defineProperty(Address.prototype, 'city', {
  get: function () {
    return this._city;
  },
  set: function (val) {
    this._city = val;
    this.country = this.country_list.split(';')[0]; 
  }
})

function createAddress(req) {
  return new Address();
}
```

Windows 的命令行下，读者可以运行 demo15 来查看实际的效果。

```
bin\jsdemo15
```

#### 14.1.3 动态界面

我们在本章的开头，展示了用 visible 属性来实现一定程度的动态界面，但是如果有大量控件都需要通过 visible 来控制，XML 文件写起来就很繁琐。这时我们可以用 pages 控件对需要显示和隐藏的控件进行分组。

比如，我们有一个通信设置界面，通信有串口和 socket 两种方式，只能二选一。由于两者的参数截然不同，此时就可以把串口和 socket 的参数分别放到不同的 page 中，然后通过 type 进行切换。

* 串口界面：

![](images/uart.png)

* Socket 设置界面

![](images/socket.png)

视图的 XML 文件：

```xml
<window v-model="com_settings.js"> 
  <combo_box x="r:24" y="10" w="200" h="30" options="UART;SOCKET" v-data:value="{type}" readonly="true"/>
  <pages x="10" y="50" w="-20" h="-90" v-data:value="{type}">
    <view x="0" y="0" w="100%" h="100%" children_layout="default(c=1,h=25,m=0,s=5)">
      <row children_layout="default(c=0,r=1,m=0,s=5)">
        <label text="Device" w="80"/>
        <combo_box w="200" options="COM1;COM2;COM3" v-data:text="{device}" readonly="true"/>
      </row>
      <row children_layout="default(c=0,r=1,m=0,s=5)">
        <label text="Baud Rate" w="80"/>
        <combo_box w="200" options="9600;115200;" v-data:text="{baudrate}" readonly="true"/>
      </row>
      <row children_layout="default(c=0,r=1,m=0,s=5)">
        <label text="Parity" w="80"/>
        <combo_box w="200" options="none;odd;even" v-data:value="{parity}" readonly="true"/>
      </row>
    </view>
    <view x="0" y="0" w="100%" h="100%" children_layout="default(c=1,h=25,m=0,s=5)">
      <row children_layout="default(c=0,r=1,m=0,s=5)">
        <label text="IP" w="80"/>
        <edit w="200" v-data:text="{ip, Trigger=Changing}" max="15"/>
      </row>
      <row children_layout="default(c=0,r=1,m=0,s=5)">
        <label text="Port" w="80"/>
        <edit  w="200" input_type="uint" min="0" max="10000" auto_fix="true" v-data:text="{port, Trigger=Changing}"/>
      </row>
    </view>
  </pages>
  <label x="10" y="m" w="100%" h="30" v-data:text="{summary}" />

</window>

```

重点看看下面两行代码，combo\_box 和 pages 都绑定到 type 属性上，用户通过 combo\_box 选择不同的通信方式时，pages 会自动切换。通过 pages 的切换，就可以更灵活的实现动态界面。

```xml
  <combo_box x="r:24" y="10" w="200" h="30" options="UART;SOCKET" v-data:value="{type}" readonly="true"/>
  <pages x="10" y="50" w="-20" h="-90" v-data:value="{type}">
```

ViewModel 实现非常简单，就是几个数据成员。

```js
function ComSettings() {
  this.type = 0;

  this.ip = "192.168.1.1"
  this.port = "8088"

  this.device = "COM1"
  this.baudrate = "9600"
  this.parity = 0
}

Object.defineProperty(ComSettings.prototype, 'summary', {
  get: function () {
    var summary = '';

    if(this.type == 0) {
      var parity_name = ["None", "Odd", "Even"];
      summary = 'UART: ' + this.device + ' ' + this.baudrate + ' ' + parity_name[this.parity];
    } else {
      summary = "SOCKET: " + this.ip + ' ' + this.port;
    }

    return summary;
  }
})

function createComSettings(req) {
  return new ComSettings();
}

```

Windows 的命令行下，读者可以运行 demo16 来查看实际的效果。

```
bin\jsdemo16
```

### 14.2 嵌入表达式

### 14.3 ListView 的绑定

### 14.4 动画相关函数

### 14.5 外部设备的集成